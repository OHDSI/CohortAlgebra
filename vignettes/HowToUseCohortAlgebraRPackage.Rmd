---
title: "How to Use CohortAlgebra R Package"
author: "Gowtham A. Rao"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: yes     
  html_document:
    number_sections: yes
    toc: yes  
vignette: >
  %\VignetteIndexEntry{Creating a study package}
  %\VignetteEncoding{UTF-8}    
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  comment = "#>",
  error = FALSE,
  tidy = FALSE)
```


# Introduction

(This package is NOT part of HADES.)

The idea behind this package is to allow the construction of new cohorts from previously instantiated cohorts in the cohort table. All cohorts in OHDSI have a standard definition: "A cohort is a set of persons who satisfy one or more inclusion criteria for a duration of time."

- One person may belong to multiple cohorts
- One person may belong to the same cohort for multiple different time periods
- One person may not belong to the same cohort multiple times during the same period of time
- A cohort may have zero or more members

This is represented in a cohort table as cohort_definition_id, subject_id, cohort_start_date and cohort_end_date. For more details about the concept of a cohort please review [The Book of OHDSI](https://github.com/OHDSI/TheBookOfOhdsi).

This package allows the creation of new cohorts from previously instantiated cohort table using cohort algebra (similar to temporal set algebra). The output is one or more new cohorts.

## Installation
- This  is an installable R-package that may be installed as follows: 
```{r tidy=FALSE,eval=FALSE}
  remotes::install_github("OHDSI/CohortAlgebra")
```

## Cohort UNION

Given two or more cohorts, an UNION operator on these cohorts creates a new cohort with continuous days the person was present in any of the cohorts.

![Cohort Union](CohortUnion.png)
The parameter purgeConflicts will delete any cohort records in the cohort table where cohortId is the cohortId of the newCohort (in this example 4.)


```{r tidy=FALSE,eval=FALSE}
library(DatabaseConnector)
 library(CohortAlgebra)
library(dplyr, warn.conflicts = FALSE)

connectionDetails <- createConnectionDetails(dbms = "sqlite", server = ":memory:")
con <- connect(connectionDetails)

# create the cohorts to union
cohort <- tibble::tribble(
  ~cohort_definition_id, ~subject_id, ~cohort_start_date, ~cohort_end_date,
  1,                     1,            "2022-01-01",       "2022-03-01",
  2,                     1,            "2022-02-10",       "2022-05-10",
  3,                     1,            "2022-08-15",       "2022-12-30") %>% 
   mutate(across(matches("date"), as.Date))

dbWriteTable(con, "cohort", cohort, overwrite = TRUE)

dbGetQuery(con, "select * from main.cohort") %>% 
  mutate(across(matches("date"), ~as.Date(., origin = "1970-01-01")))

unionCohorts(connection = con,
            cohortDatabaseSchema = "main",
            cohortTable = "cohort",
            cohortIds = c(1,2,3),
            newCohortId = 4)

dbGetQuery(con, "select * from main.cohort where cohort_definition_id = 4") %>% 
  mutate(across(matches("date"), ~as.Date(., origin = "1970-01-01")))
```

## Cohort Intersection

The intersection of two or more cohorts is a new cohort that contains the person-days included in all of the input cohorts.

```{r}

intersectCohorts(connection = con,
            cohortDatabaseSchema = "main",
            cohortTable = "cohort",
            cohortIds = c(1,2,3),
            newCohortId = 5)

dbGetQuery(con, "select * from main.cohort where cohort_definition_id = 5") %>% 
  mutate(across(matches("date"), ~as.Date(., origin = "1970-01-01")))
```



## Cohort Minus

The minus operation (also often called set difference or relative complement) of two cohorts A and B is denoted A - B and contains the person-days that are in A but are not in B. Note that the order of the cohorts matters: A - B is not the same as B - A.

This operation can be defined in terms of the complement and interection: A - B is the same as the intersection of A and the complement of B.

```{r}

minusCohorts(connection = con,
             cohortTable = "cohort",
             firstCohortId = 1, 
             secondCohortId = 2, 
             newCohortId = 6)

dbGetQuery(con, "select * from main.cohort where cohort_definition_id = 6") %>% 
  mutate(across(matches("date"), ~as.Date(., origin = "1970-01-01")))
```


