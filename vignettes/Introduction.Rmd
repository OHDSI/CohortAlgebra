---
title: "Introduction to CohortAlgebra"
author: "Adam Black"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    toc: yes  
vignette: >
  %\VignetteIndexEntry{Introduction to CohortAlgebra}
  %\VignetteEncoding{UTF-8}    
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  comment = "#>",
  error = FALSE,
  tidy = FALSE)
```

CohortAlgebra explores the creation of algebraic operations on OHDSI cohorts and cohort definitions. This vignette will examine why and how we might want to define these operations as well as how to use the functions in CohortAlgebra to perform them.

# Motivation

Formal systems that are the domain of mathematics often exhibit properties that are both aesthetic and utilitarian. For example, symmetry, a property at the heart of algebraic systems, has application in both computer science and art. By adding a formal algebraic structure to cohort definitions we can apply theory developed in the abstract and apply it to the special case of observational cohort definition. Specifically, our aim is to apply the theory of lattices to OHDSI cohort definitions.

# Set theory

This vignette assumes no prior knowledge in math or lattice theory but will use math notation for it's ability to be both precise and concise.

In OHDSI, "A cohort is a set of persons who satisfy one or more inclusion criteria for a duration of time."

- One person may belong to multiple cohorts
- One person may belong to the same cohort for multiple different time periods
- One person may not belong to the same cohort multiple times during the same period of time
- A cohort may have zero or more members


In math, a *set* is simply a collection of objects where the term "object" is used in a broad sense to mean anything we can formally define. The objects in a set are called *elements*.

- One object may belong to multiple sets
- One object may not belong to the same set multiple times
- A set may have zero or more elements

We can define an OHDSI cohort as a set of person-days satisfying one or more inclusion criteria. The "objects" under consideration are the days in a person's life. More specifically they are the days during which a person was under observation by some data capture mechanism. In the OMOP Common Data Model (CDM) the entire set of person-days under observation is given by the `observation_period` table which represents the largest possible cohort. All other cohorts are subsets of the `observation_period`.

Let's call $O$ the set of all person-days in the observation period table of an arbitrary OMOP CDM.

In math, a set $C$ is a subset of another set $O$ if and only if every element of $C$ is also an element of $O$. The set of all subsets of $O$ is called the *power set* of $O$. There is a unique set with no elements called the *empty set* which is a subset of every other set including $O$. Thus the power set of $O$ represents every possible cohort including the empty cohort which we can denote $\emptyset$

# Partial Order

Order is a fundamental concept in math represented with the symbols $\ge$ and $\le$. There is a natural order relation we can use with sets where $A \le B$ if and only if $A$ is a subset of $B$. Since cohorts are sets of person-days we can use this order relation with cohorts. 

For example in ["Validating an algorithm for multiple myeloma based on administrative data using a SEER tumor registry and medical record review"](https://pubmed.ncbi.nlm.nih.gov/30719785/) Brandenburg et al. define four algorithms for identifying multiple myeloma patient-days. 

Cohort 1: 2 diagnosis codes
Cohort 2: 2 diagnosis codes and 1 procedure
Cohort 3: 2 diagnosis codes and 1 procedure and 1 drug
Cohort 4: 2 diagnosis codes and 1 procedure and at most 1 dx for Monoclonal gammopathy

For any CDM the following order relations will be true.

$$
O \ge Cohort1 \ge Cohort2 \ge Cohort3 \ge \emptyset
$$


$$
O \ge Cohort1 \ge Cohort2 \ge Cohort4 \ge \emptyset
$$

Can we compare Cohort 3 and Cohort 4? It is possible that on some datasets we may have $Cohort3 \ge Cohort4$ while on others we might have $Cohort4 \ge Cohort3$. The most likely case is that neither cohort will be a subset of the other making them incomparable. This illustrates an important point about order relation on subsets. It is a *partial ordering*. Not all subsets are comparable.

Partially ordered sets can be visualized using a Hasse Diagram.

```{r hasse1, echo=FALSE, message=FALSE}
data <- matrix(data = FALSE, ncol = 6, nrow = 6)
data[1, 2:6] <- TRUE
data[2, 3:6] <- TRUE
data[3, 4:6] <- TRUE
data[4, 6] <- TRUE
data[5, 6] <- TRUE
hasseDiagram::hasse(data, labels=c("Observation period", paste("Cohort", 1:4, sep="-"), "Empty cohort"))
```


# Cohort Lattices

Lattices provide additional constraints and structure on partially ordered sets. We can put OHDSI cohorts into a lattice structure by defining two binary operations on cohorts: Union and Intersection denoted $\bigcup$ and $\bigcap$ respectively. These operations come directly from set theory. 

If $A$ and $B$ are cohorts (i.e. subsets of $O$) then:

$A \bigcup B$ is the set of all patient-days in either $A$ or $B$

$A \bigcap B$ is the set of all patient-days in both $A$ and $B$

If a set of cohorts contains the union and intersection of any two cohorts it contains then it is a lattice. The power set of $O$ (i.e. all possible cohorts of an arbitrary CDM) is a lattice.


The two cohorts in our example that are not related by ordering are Cohort 3 and Cohort 4 so let's define two new cohorts, $Cohort5 = Cohort3 \cup C4$ and $Cohort6 = Cohort3 \cap Cohort4$ to the diagram.

```{r hasse1, echo=FALSE, message=FALSE}
data <- matrix(data = FALSE, ncol = 8, nrow = 8)
data[1, 2:8] <- TRUE
data[2, 3:8] <- TRUE
data[3, 4:8] <- TRUE
data[4, 5:8] <- TRUE
data[5, 7:8] <- TRUE
data[6, 7:8] <- TRUE
data[7, 8] <- TRUE
# Rgraphviz’, ‘graph
labels <- c("Observation period", 
            paste("Cohort", 1:2, sep="-"),
            "Cohort-3 Union Cohort-4",
            paste("Cohort", 3:4, sep="-"), 
            "Cohort-3 Intersect Cohort-4",
            "Empty cohort")
hasseDiagram::hasse(data, labels = labels)
```

"Completeness" ?

Mapping from cohort definitions to generated cohorts.




