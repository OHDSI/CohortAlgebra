---
title: "The Algebra of Cohorts"
author: "Adam Black"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    toc: yes  
vignette: >
  %\VignetteIndexEntry{Introduction to CohortAlgebra}
  %\VignetteEncoding{UTF-8}    
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  comment = "#>",
  error = FALSE,
  tidy = FALSE)
```

_CohortAlgebra_ explores the application of [the algebra of sets](https://en.wikipedia.org/wiki/Algebra#Abstract_algebra) to OHDSI cohorts. This vignette will examine why and how to define these operations as well as their potential application to phenotyping across a data network. By adding an algebraic structure to cohort definitions we apply theory developed in the abstract to the special case of observational cohort definition. 

# Set theory

In OHDSI, "A cohort is a set of persons who satisfy one or more inclusion criteria for a duration of time."

- One person may belong to multiple cohorts
- One person may belong to the same cohort for multiple different time periods
- One person may not belong to the same cohort multiple times during the same period of time
- A cohort may have zero or more members

In mathematics, a *set* is simply a collection of objects where the term "object" is used in a broad sense to mean anything we can formally define. The objects in a set are called *elements*.

- One object may belong to multiple sets
- One object may not belong to the same set multiple times
- A set may have zero or more elements

We can restate the definition an OHDSI cohort as "a set of person-days satisfying a set of inclusion criteria".

Formally, a _person-day_ is defined as an ordered pair $(p,d)$ where $p$ is an element of the set of all persons, $P$, and $d$ is an element of the set of all days, $D$. We will be somewhat imprecise about exactly what $P$ and $D$ are composed of but point out that for all tense and purposes they are finite. In the OMOP Common Data Model (CDM) the entire set of person-days under observation is given by the `observation_period` table which represents the largest possible cohort. All cohorts are subsets of the `observation_period`.

Let's call $O$ the set of all person-days in the observation period table of an arbitrary OMOP CDM.

In set theory, a set $C$ is a subset of another set $O$ if and only if every element of $C$ is also an element of $O$. The set of all subsets of $O$ is called the *power set* of $O$. There is a unique set with no elements called the *empty set* which is a subset of every other set including $O$. Thus the power set of $O$ represents every possible cohort including the empty cohort which we can denote $\emptyset$

Viewing cohorts as sets of person-days allows us to define three set operations on cohorts. Suppose $A$ and $B$ are cohorts (i.e. subsets of $O$).

$A \bigcup B$ is the set of all person-days in either $A$ or $B$

$A \bigcap B$ is the set of all person-days in both $A$ and $B$

$A^c$ is the set of all person-days in $O$ but not in $A$

Other operations can be defined in terms of these operations. 

$A-B = A \cap B^c$  is the set of all person days in $A$ but not in $B$

Many identities have been proven for these operations that can be applied to cohort definitions.


# Partial Order

Order is a fundamental concept in math represented with the symbols $\ge$ and $\le$. There is a natural order relation we can use with sets where $A \le B$ if and only if $A$ is a subset of $B$. Since cohorts are sets of person-days we can use this order relation with cohorts. 

For example in ["Validating an algorithm for multiple myeloma based on administrative data using a SEER tumor registry and medical record review"](https://pubmed.ncbi.nlm.nih.gov/30719785/) Brandenburg et al. define four algorithms for identifying multiple myeloma patient-days. 

Cohort 1: 2 diagnosis codes
Cohort 2: 2 diagnosis codes and 1 procedure
Cohort 3: 2 diagnosis codes and 1 procedure and 1 drug
Cohort 4: 2 diagnosis codes and 1 procedure and at most 1 dx for Monoclonal gammopathy

For any CDM the following order relations will be true.

$$
O \ge Cohort1 \ge Cohort2 \ge Cohort3 \ge \emptyset
$$


$$
O \ge Cohort1 \ge Cohort2 \ge Cohort4 \ge \emptyset
$$

Can we compare Cohort 3 and Cohort 4? It is possible that on some datasets we may have $Cohort3 \ge Cohort4$ while on others we might have $Cohort4 \ge Cohort3$. The most likely case is that neither cohort will be a subset of the other making them incomparable. This order relation on subsets is a *partial ordering*. Not all subsets are comparable.

Partially ordered sets can be visualized using a diagram where arrows are used to denote the order relations. 

```{r, echo=FALSE, message=FALSE}
data <- matrix(data = FALSE, ncol = 6, nrow = 6)
data[1, 2:6] <- TRUE
data[2, 3:6] <- TRUE
data[3, 4:6] <- TRUE
data[4, 6] <- TRUE
data[5, 6] <- TRUE
hasseDiagram::hasse(data, labels=c("Observation period", paste("Cohort", 1:4, sep="-"), "Empty cohort"))
```


# Cohort Lattices

Lattices provide additional constraints and structure on partially ordered sets. We can put OHDSI cohorts into a lattice structure by using two binary operations on cohorts: Union and Intersection.

If a set of cohorts contains the union and intersection of any two cohorts it contains then it is guaranteed to be a lattice. The power set of $O$ (i.e. all possible cohorts of an arbitrary CDM) is a lattice.


The two cohorts in our example that are not related by ordering are Cohort 3 and Cohort 4 so let's define two new cohorts, $Cohort5 = Cohort3 \cup C4$ and $Cohort6 = Cohort3 \cap Cohort4$ to the diagram.

```{r, echo=FALSE, message=FALSE}
data <- matrix(data = FALSE, ncol = 8, nrow = 8)
data[1, 2:8] <- TRUE
data[2, 3:8] <- TRUE
data[3, 4:8] <- TRUE
data[4, 5:8] <- TRUE
data[5, 7:8] <- TRUE
data[6, 7:8] <- TRUE
data[7, 8] <- TRUE
# Rgraphviz’, ‘graph
labels <- c("Observation period", 
            paste("Cohort", 1:2, sep="-"),
            "Cohort-3 Union Cohort-4",
            paste("Cohort", 3:4, sep="-"), 
            "Cohort-3 Intersect Cohort-4",
            "Empty cohort")
hasseDiagram::hasse(data, labels = labels)
```



Can we describe what patient-days are being captured by the two new cohorts? What are the definitions of these cohorts built using the union and intersection operations?

If think of cohort definitions as a logical expression composed of inclusion criteria we can make use of algebraic properties of logical AND and OR operations.

$$
Cohort3 \bigcap Cohort4 = \\
(2dx \space AND \space 1procedure \space  AND \space 1drug)  \space AND  \space (2dx \space AND \space 1procedure \space  AND \space \le 1Monoclonalgammopathy) = \\
(2dx \space AND \space 1procedure \space)  \space AND  \space (1drug \space AND \space \le 1Monoclonalgammopathy) = \\
2dx \space AND \space 1procedure  \space AND  \space 1drug \space AND \space \le 1Monoclonalgammopathy 
$$


$$
Cohort3 \bigcup Cohort4 = \\
(2dx \space AND \space 1procedure \space  AND \space 1drug)  \space OR  \space (2dx \space AND \space 1procedure \space  AND \space \le 1Monoclonalgammopathy) = \\
2dx \space AND \space 1procedure  \space AND  \space (1drug \space OR \space \le 1Monoclonalgammopathy) 
$$


* Cohort 1: 2 diagnosis codes
* Cohort 2: 2 diagnosis codes and 1 procedure
* Cohort 3 $\cup$ 4: 2 diagnosis codes and 1 procedure and (1 drug or at most 1 dx for Monoclonal gammopathy) 
* Cohort 3: 2 diagnosis codes and 1 procedure and 1 drug
* Cohort 4: 2 diagnosis codes and 1 procedure and at most 1 dx for Monoclonal gammopathy
* Cohort 3 $\cap$ 4: 2 diagnosis codes and 1 procedure and 1 drug and at most 1 dx for Monoclonal gammopathy


What we really have is two different ordered sets giving rise two two different cohort lattices. We have an ordering on *cohort definitions* and we also have an ordering on *generated cohorts*. We also have a natural mapping from cohort definitions to generated cohorts that preserves this order relation, namely the generation function which we will call $G$. The generate function maps cohort definitions to generated cohorts *on a specific CDM dataset*. Since we are interested in properties of $G$ that are not dependent on which CDM dataset we are using we will treat $G$ as the generate function for an arbitrary CDM dataset.


# Cohort Defintion Lattice

In OHDSI we have several different ways to create cohorts: circe-be cohorts created with Atlas or Capr, custom SQL, probabilistic cohorts created with Aphrodite. For the purposes of CohortAlgebra we are interested in cohort definitions that have well defined ordering as well as union and intersection operations.  

It might be better to abstact the operations of union and intersection. Namely we have two operations that are each known by several different names:

Operation 1: $\cup$, union, join, $\lor$, logical OR

Operation 2: $\cap$, intersection, meet, $\land$, logical AND


The terms *join*, $\lor$, and *meet*, $\land$, are often used when discussing lattices to we will use these for cohort definitions. It is not clear yet if how to define these operations for circe-be cohort definitions.


# Properties of the generation function $G$

Now that we have a cohort definition lattice and a generated cohort lattice we can explore the properties of the function connecting them, $G$. We characterize the relationship between a cohort defintion lattice and specific CDM, e.g. Eunomia, by the structure of the cohort definition lattice that is preserved by the generation function for that CDM $G_{Eunomia}$.

The first property to check is that $G$ preserves order, or *monotonicity*. For any two cohort definitions $A$ and $B$, if $A \ge B$ implies that $G(A) \ge G(B)$ then $G$ preserves order and is called an *monotone map*


TODO: show that G preserves order in the multiple myeloma example.


The next property to consider is that $G$ preserves the two operations we have defined.

 $G$ preserves the lattice structure and is called a *lattice homomorphism* if for any two cohort definitions $A$ and $B$ we have 

$$
G(A \lor B) = G(A) \cup G(B) \\
G(A \land B) = G(A) \cap G(B) \\
$$
Equality here means set equality: both sets contain the same patient-days. Keep in mind that these are true for any CDM dataset but of course $G_{cdm1}(A \cup B)$ is not necessarily equal to $G_{cdm2}(A \cup B)$. 


TODO: Show that G perserves the lattice structure in the multiple myeloma example.








